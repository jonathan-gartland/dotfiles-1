#!/bin/bash
# Based opon http://www.bennee.com/~alex/news.php?wl_mode=more&wl_eid=1283
#
#
# Emacs Specific setup
#
# There is only one editor (although I can get to it in different ways).
# For most stuff I want to use emacsclient to spawn a quick shell and
# for emacs 23 I want to ensure the daemon is always running for the user.
#
# Luckily this is covered by specifying -a '' which will spawn a daemon if
# one is not running
#

PATH="$HOME/bin:$HOME/local/bin:$PATH"

if [[ "$DISPLAY" == "" ]]; then
    # Can we use muti-tty?
    emacsclient --help | grep "\-\-tty" > /dev/null
    if [[ "$?" == "0" ]]; then
        # Thats a yes
        EMACS_CMD="emacsclient -a '' -t"
    else
        # Hmmm, opening in another pane would be a pain?
        EMACS_CMD="emacs -nw "
    fi
else
    EMACSCLIENT="emacsclient -c -a ''"

    EMACS_CMD=""
    if [[ "${0}" =~ "/e$" ]]; then 
	EMACS_CMD="$EMACSCLIENT -n"
    fi

    if [[ "${0}" =~ "/ew$" ]]; then 
	EMACS_CMD="$EMACSCLIENT"
    fi

    if [[ $EMACS_CMD == "" ]]; then
	echo "EMACS_CMD is undefined."
	exit 1
    fi
fi

emacsclient -a '' -e "
(require 'server) 
(when (and (functionp 'server-running-p) (not (server-running-p)))
  (server-start))
" > /dev/null
$EMACS_CMD $*
